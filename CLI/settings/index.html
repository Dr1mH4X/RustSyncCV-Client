<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RustSyncCV 设置</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 24px; }
    label { display:block; margin-top: 12px; font-weight: 600; }
    input[type="text"], input[type="password"], input[type="number"] { width: 420px; padding: 6px 8px; }
    .row { margin-bottom: 8px; }
    .btns { margin-top: 16px; }
    button { padding: 6px 12px; margin-right: 8px; }
    .msg { margin-top: 12px; color: #0a7; }
    .err { margin-top: 12px; color: #c00; }
  </style>
</head>
<body>
  <h2>设置</h2>
  <div class="row">
    <label>Server URL</label>
    <input id="server_url" type="text" placeholder="ws(s)://.../ws" />
  </div>
  <div class="row">
    <label>Token</label>
    <input id="token" type="text" placeholder="可为空（用户名/密码二选一）" />
  </div>
  <div class="row">
    <label>用户名</label>
    <input id="username" type="text" />
  </div>
  <div class="row">
    <label>密码</label>
    <input id="password" type="password" />
  </div>
  <div class="row">
    <label>图片最大KB</label>
    <input id="max_image_kb" type="number" min="64" max="8192" step="64" />
  </div>
  <div class="row">
    <label>同步间隔(秒)</label>
    <input id="sync_interval" type="number" min="1" max="3600" step="1" />
  </div>
  <div class="row">
    <label>
      <input id="insecure" type="checkbox" /> 允许不安全证书（仅调试，生产环境请关闭）
    </label>
  </div>
  <div class="row">
    <label>
      <input id="autostart" type="checkbox" /> 开机自启
    </label>
  </div>

  <div class="btns">
    <button id="save">保存</button>
    <button id="save_apply">保存并应用</button>
  </div>
  <div id="msg" class="msg"></div>
  <div id="err" class="err"></div>

  <script type="module">
    import { invoke } from "https://cdn.jsdelivr.net/npm/@tauri-apps/api@2.0.0/dist/index.min.js";

    const $ = (id) => document.getElementById(id);
    const fill = (s) => {
      $("server_url").value = s.server_url ?? "";
      $("token").value = s.token ?? "";
      $("username").value = s.username ?? "";
      $("password").value = s.password ?? "";
  $("max_image_kb").value = s.max_image_kb ?? 512;
  $("sync_interval").value = s.sync_interval ?? 5;
  $("insecure").checked = !!s.trust_insecure_cert;
      $("autostart").checked = !!s.autostart;
    };
    const collect = () => ({
      server_url: $("server_url").value.trim(),
      token: $("token").value.trim() || null,
      username: $("username").value.trim() || null,
      password: $("password").value.trim() || null,
  max_image_kb: Number($("max_image_kb").value) || 512,
  sync_interval: Number($("sync_interval").value) || 5,
  trust_insecure_cert: $("insecure").checked,
      autostart: $("autostart").checked,
    });

    const showMsg = (m) => { $("msg").textContent = m; $("err").textContent = ""; };
    const showErr = (m) => { $("err").textContent = m; $("msg").textContent = ""; };

    try {
      const s = await invoke("load_gui_settings");
      fill(s);
    } catch (e) {
      console.error(e);
    }

    $("save").addEventListener("click", async () => {
      try {
        await invoke("save_gui_settings", { newSettings: collect() });
        showMsg("已保存");
      } catch (e) { showErr(String(e)); }
    });

    $("save_apply").addEventListener("click", async () => {
      try {
        await invoke("save_and_apply_gui_settings", { newSettings: collect() });
        showMsg("已保存并应用，侧车已重启");
      } catch (e) { showErr(String(e)); }
    });
  </script>
</body>
</html>
